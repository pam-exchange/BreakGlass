# Breakglass

When using a Privileged Access Management (PAM) system one use case or scenario 
is to let PAM establish sessions to servers, systems and applications without 
revealing the password (or SSH key) to the individual. Furtheremore, the passwords
are generated by the PAM system and is not known to users.
This is standard operation with PAM. 

However, there is a concern by the organization which must be addressed.

This is the question: How to open sessions to servers (and applications) if PAM is not available?

One answer is to use breakglass accounts for emergency access.
The accounts can be set manually or PAM can set the passwords to random values.

Also see a general description about Breakglass [here](Docs/Breakglass.md).

Assume PAM is the master of breakglass accounts (Breakglass category 2), it should be possible to store breakglass accounts and their password/SSH private key in a secure location, and where it is possible to retrieve passwords without PAM being available.

This is what this Powershell script is about.

## How it works

The main script Beeakglass.ps1 is a Powershell (v5.1), which is fetching account information including password/SSH private key from PAM and store them in a local vault. If there are entries in the local vault no longer in PAM, they are removed from the local vault. New and changed breakglass accounts in PAM are added/updated in the local vault.

An example is shown here

```
> .\Breakglass.ps1 -PAMType SymantecPAM -Update
```

![Running Breakglass](/Docs/BreakGlass-Example.png)

> [!IMPORTANT]
> The naming of the breakglass accounts is 'hostname | platform/application | username'. The password for the entry in KeePassXC is the account password. If the breakglass account is using SSH key pairs, the private key is found in the entry notes.

> [!CAUTION]
> Do not have KeePassXC open in the desktop GUI when running the script. Having the program open may course errors and unexpected behaviour. This includes that breakglass account password/SSH keys was changed in PAM **without** storing a copy in the local vault.


### Command Syntax

The main script Breakglass.ps1 has the following command line options

```
> breakglass.ps1 [-PAMType PasswordSafe|SymantecPAM] [-VaultType KeePassXC] [-Update] [-WhatIf] [-Quiet]
```

| Parameter  | Default | Description |
|:--- | :--- | :--- |
| -PAMType \<string\> | PasswordSafe | Supported PAM types are `PasswordSafe` and `SymantecPAM`. | 
| -VaultType \<string\> | KeePassXC | Only `KeePassXC`is supported. | 
| -Update | \<not used\> | If the switch is used, PAM till attempt to update the breakglass account password/SSH key pair before they are aligned with the local vaule. | 
| -WhatIf | \<not used\> | If the switch is used, changes are not performed in PAM (update password) nor in the local vault. It will however show which actions will be performed without the -WhatIf option. | 
| -Quiet | \<not used\> | If the switch is used only exceptions (errors) are shown to the user. If used together with `-WhatIf`, then the `-Quiet`  option is ignored. | 


### Configuration file

The script `breakglass` is using a configuration file, which contains details about hostnames, usernames, passwords and API keys required when connecting to PAM and when updating the local vault.

It is best practise **never** keeping sensitive information in files as clear text, and it is impractical asking a user to enter it everytime the breakglass script is run.
A solution for this is to use Powershell mechanism to generate a secre string and this is then saved to disk. When saved it is protected such that it only be used on the same system where it was generated and only by the same logged in user.

For this purpose the script `breakglass-config` is available. Edit the file and fill in the details for your environment. It is not necessary to fill in details for both Password Safe and Symantec PAM. When running the `breakglass-config`script it will encrypt passwords and API keys and store the whole lot as a file in `c:\temp\Breakglass-<hostname>_<username>.properties` where \<hostname\> and \<username\> is replaced with whatever is valid when running the script brakglaaa-config. 

> [!NOTE]
> The configuration file can only be used on the system where it was generated (running breakglass-config) and only by the user logged in when generating the file. It cannot be moved to a different computer and cannot be used by a different user.
> Also note that it is very strongly recommended and absolutely best practis to delete the script `breakglass-config` after it has been used. Keep the modified breakglass-config file secure and inaccessible for alsmost everybody.

>[!CAUTION]
> Never ever checkin the updated `breakglass-config.ps1` file to a source control system.
> 


```
$configKeePassXC= @{
        type="KeePassXC"; 
		DatabasePath= "c:\temp\BreakGlass.kdbx"; 
		KeyFilePath= "c:\temp\BreakGlass.keyfile"; 
		MasterPassword= "<SuperSecretPassword>"; 
        Group= "BreakGlass";
    }

$configPasswordSafe = @{
        type="PasswordSafe"; 
		DNS= "<dns name for Password Safe>";
		username= "api_Breakglass"; 
		password= "Kuxxxxxxxxxxxxxxxxxxxxxxxxxxmq3T!"; 
		apiKey= "4ef9xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx284a66ce3";
        Workgroup= "Default Workgroup";
    }

$configSymantecPAM = @{
        type="SymantecPAM"; 
		DNS= "<dns name for Symantec PAM>";
		username= "cli_breakglass"; 
		password= "<AnotherSecretPassword>"; 
    }
```

There are seperate documents for configuration in [Password Safe](Docs/PasswordSafe.md) and [Symantec PAM](Docs/SymantecPAM.md) available.


## Content

The two scripts `break