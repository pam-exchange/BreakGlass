# Breakglass

When using a Privileged Access Management (PAM) system one use case or scenario 
is to let PAM establish sessions to servers, systems and applications without 
revealing the password (or SSH key) to the individual. Furtheremore, the passwords
are generated by the PAM system and is not known to users.
This is standard operation with PAM. 

However, there is a concern by the organization which must be addressed.

This is the question: How to open sessions to servers (and applications) if PAM is not available?

One answer is to use breakglass accounts for emergency access.
The accounts can be set manually or PAM can set the passwords to random values.

Also see a general description about Breakglass [here](Docs/Breakglass.md).

Assume PAM is the master of breakglass accounts (Breakglass category 2), it should be possible to store breakglass accounts and their password/SSH private key in a secure location, and where it is possible to retrieve passwords without PAM being available.

This is what this Powershell script is about.

## How it works

The main script Beeakglass.ps1 is a Powershell (v5.1), which is fetching account information including password/SSH private key from PAM and store them in a local vault. If there are entries in the local vault no longer in PAM, they are removed from the local vault. New and changed breakglass accounts in PAM are added/updated in the local vault.

An example is shown here

```
> .\Breakglass.ps1 -PAMType SymantecPAM -Update
```

![Running Breakglass](/Docs/BreakGlass-Example.png)

> [!IMPORTANT]
> The naming of the breakglass accounts is 'hostname | platform/application | username'. The password for the entry in KeePassXC is the account password. If the breakglass account is using SSH key pairs, the private key is found in the entry notes.

> [!CAUTION]
> Do not have KeePassXC open in the desktop GUI when running the script.


### Command Syntax

The main script Breakglass.ps1 has the following command line options

```
> breakglass.ps1 [-PAMType PasswordSafe|SymantecPAM] [-VaultType KeePassXC] [-Update] [-WhatIf] [-Quiet]
```

| Parameter  | Default | Description |
|:--- | :--- | :--- |
| -PAMType <string> | `PasswordSafe` | Supported PAM types are `PasswordSafe` and `SymantecPAM`. | 
| -VaultType <string> | `KeePassXC` | Only `KeePassXC`is supported. | 
| -Update | <not used> | If the switch is used, PAM till attempt to update the breakglass account password/SSH key pair before they are aligned with the local vaule. | 
| -WhatIf | <not used> | If the switch is used, changes are not performed in PAM (update password) nor in the local vault. It will however show which actions will be performed without the -WhatIf option. | 
| -Quiet | <not used> | If the switch is used only exceptions (errors) are shown to the user. If used together with `-WhatIf`, then the `-Quiet`  option is ignored. | 

## Content

There are two scripts available. The configuration script is required to setup keys and passwords for accessing PSM and 

The Powershell scripts and modules presented here will retrieve account details including 
passwords (or SSH private key) and save them in a KeePassXC database.

The starter is the script breakglass-Config.ps1. It is used to create a configuration file with encrypted passwords
and API tokens, hostnames, locations for KeePassXC database and connections to PAM. This script is executed from
a system (laptop) used to store the KeePassXC database for breakglass access. The encryption is unique to the host and user 
running the script. 

After the configuration file is created, the configuration script must be removed.
It does contain clear text passwords for accessing the KeePassXC database, passwords and API keys for 
accessing PAM, etc. The file should not be put under source control and access to the script should be very 
restricted.

The main event is the script BreakGlass.ps1. This will connect to PAM, fetch all accounts visible in
the defined view, fetch passwords for each account. Finally it will create a KeePassXC database (if not available) 
and adjust the breakglass accounts found. If a new account is found in PAM, it is created in KeePassXC. If an account was
removed in PAM, it is removed in KeePassXC. Finally, if a password was updated in PAM, it is updated in KeePassXC.

It is important that the PAM system does **not** automatically update passwords for BreakGlass accounts. Time to update 
passwords for breakglass accounts is a manual process Updating 
passwords should be con
An option is to let the breakglass script initiate a password update before the new password is copied to KeePassXC.

The BreakGlass script can fetch account information for breakglass accounts from either BeyondTrust Password 
Safe or Symantec PAM, and store them in a KeePassXC database. A filter is defined in PAM allowing a view 
of just the defined breakglass accounts. 
In Symantec PAM such a filter is established using a target group, Credentials Manager group and Credentials Manager role.
In BeyondTrust Password Safe such a filter is established using a smart group and features.


